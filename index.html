<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esercizi Cinese 2 B2 - Modalità Ottimizzate</title>
    <!-- Caricamento di Tailwind CSS per uno styling rapido e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Impostazione del font Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Colore di sfondo leggero */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Assicura che occupi l'intera altezza del viewport */
            padding: 1rem; /* Padding generale per i bordi */
            overflow: hidden; /* Evita scrollbar inutili sulla landing page */
        }
        /* Stili aggiuntivi per i messaggi di feedback */
        .feedback-message {
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
        }
        .feedback-correct {
            background-color: #d1fae5; /* Verde chiaro */
            color: #065f46; /* Verde scuro */
        }
        .feedback-incorrect {
            background-color: #fee2e2; /* Rosso chiaro */
            color: #991b1b; /* Rosso scuro */
        }
        /* Stili base per il contenitore della card (senza max-width fisso qui) */
        .card-container {
            width: 100%;
            box-sizing: border-box; /* Assicura che padding e border non espandano la larghezza */
        }
        .button {
            @apply px-6 py-3 rounded-xl shadow-md transition-all duration-300 ease-in-out;
        }
        .button-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
        }
        .button-secondary {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50;
        }
        .explanation {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #4a5568; /* Grigio scuro */
            font-weight: normal;
        }
        #question-area {
            min-height: 120px; /* Ensure enough height for multi-line questions */
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word; /* Ensure long words break */
        }
        #score-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 1rem;
            text-align: center;
        }
        #final-score-message {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a202c;
            margin-top: 1.5rem;
            text-align: center;
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 0.5rem;
        }
        .multiple-choice-option {
            @apply flex items-center p-3 my-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-200;
        }
        .multiple-choice-option input[type="radio"] {
            @apply mr-3 w-5 h-5 text-blue-600 focus:ring-blue-500;
        }
        .multiple-choice-container {
            margin-top: 1rem;
        }
        .love-message {
            @apply text-center text-red-500 text-2xl font-bold mb-4;
        }
        /* Stili per la landing page iniziale */
        #landing-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f4f8; /* Sfondo simile al body per continuità */
            z-index: 100; /* Assicura che sia sopra il contenuto degli esercizi */
            padding: 1rem;
        }
        #exercise-app-container {
            display: none; /* Nasconde l'app degli esercizi all'inizio */
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        /* --- Ottimizzazioni specifiche per modalità --- */

        /* Modalità Mobile */
        body.mobile-layout #main-card-container {
            max-width: 380px; /* Larghezza tipica per mobile */
            padding: 0.75rem; /* Padding leggermente ridotto */
            font-size: 0.95rem; /* Font base leggermente più piccolo */
        }
        body.mobile-layout .love-message {
            font-size: 1.5rem; /* Messaggio d'amore più piccolo */
        }
        body.mobile-layout h1 {
            font-size: 2rem; /* Titolo h1 più piccolo */
        }
        body.mobile-layout p { /* Descrizione iniziale */
            font-size: 0.9rem;
        }
        body.mobile-layout #question-area {
            font-size: 1.25rem; /* Font domanda più piccolo */
            min-height: 100px; /* Altezza minima adeguata */
            padding: 0.75rem;
        }
        body.mobile-layout input#user-answer {
            font-size: 1rem; /* Font input più piccolo */
            padding: 0.75rem;
        }
        body.mobile-layout .multiple-choice-option span {
            font-size: 0.9rem; /* Font opzioni più piccolo */
        }
        body.mobile-layout .button {
            padding: 0.6rem 1.2rem; /* Padding pulsanti ridotto */
            font-size: 0.9rem;
        }

        /* Modalità Desktop */
        body.desktop-layout #main-card-container {
            max-width: 960px; /* Larghezza tipica per desktop */
            padding: 2rem; /* Padding più generoso */
            font-size: 1.1rem; /* Font base leggermente più grande */
        }
        body.desktop-layout .love-message {
            font-size: 2.25rem; /* Messaggio d'amore più grande */
        }
        body.desktop-layout h1 {
            font-size: 3rem; /* Titolo h1 più grande */
        }
        body.desktop-layout p { /* Descrizione iniziale */
            font-size: 1rem;
        }
        body.desktop-layout #question-area {
            font-size: 1.875rem; /* Font domanda più grande */
            min-height: 150px; /* Altezza minima adeguata */
            padding: 1.5rem;
        }
        body.desktop-layout input#user-answer {
            font-size: 1.125rem; /* Font input più grande */
            padding: 1rem;
        }
        body.desktop-layout .multiple-choice-option span {
            font-size: 1.05rem; /* Font opzioni più grande */
        }
        body.desktop-layout .button {
            padding: 0.8rem 1.6rem; /* Padding pulsanti più generoso */
            font-size: 1rem;
        }

        /* Responsive adjustments for very small screens, overrides specific mode styles if needed */
        @media (max-width: 480px) {
            body.mobile-layout #main-card-container {
                max-width: 100%; /* Take full width on very small screens */
                padding: 0.5rem;
            }
            body.mobile-layout h1 {
                font-size: 1.75rem;
            }
            body.mobile-layout .love-message {
                font-size: 1.25rem;
            }
            body.mobile-layout #question-area {
                font-size: 1.1rem;
                min-height: 80px;
                padding: 0.5rem;
            }
            body.mobile-layout input#user-answer {
                font-size: 0.9rem;
                padding: 0.6rem;
            }
            body.mobile-layout .multiple-choice-option {
                padding: 0.6rem;
            }
            body.mobile-layout .multiple-choice-option input[type="radio"] {
                width: 1.25rem;
                height: 1.25rem;
            }
            body.mobile-layout .multiple-choice-option span {
                font-size: 0.85rem;
            }
            body.mobile-layout .button {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Schermata di selezione iniziale -->
    <div id="landing-page">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center max-w-sm w-full">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Seleziona la Modalità</h2>
            <p class="text-gray-600 mb-8">Scegli come vuoi visualizzare l'applicazione.</p>
            <div class="flex flex-col gap-4">
                <button id="mobile-mode-button" class="button button-primary">Modalità Mobile</button>
                <button id="desktop-mode-button" class="button button-primary">Modalità Desktop</button>
            </div>
        </div>
    </div>

    <!-- Contenitore principale dell'applicazione degli esercizi (inizialmente nascosto) -->
    <div id="exercise-app-container">
        <div id="main-card-container" class="card-container bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
            <!-- Messaggio d'amore fisso -->
            <div class="love-message">
                Credo in te amore mio. TI AMO &lt;3
            </div>

            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Esercizi di Cinese 2 (Livello B2)</h1>
            <p class="text-center text-gray-600 mb-8">
                Metti alla prova le tue conoscenze con esercizi sui complementi e le frasi con 把/被!
                Scrivi la risposta corretta nel campo sottostante o seleziona l'opzione giusta. Presta attenzione ai **caratteri cinesi** e alla **punteggiatura cinese**.
            </p>

            <!-- Display del punteggio in tempo reale -->
            <div id="score-display">Punteggio: 0/0</div>

            <!-- Area per la domanda -->
            <div id="question-area" class="bg-gray-100 p-6 rounded-xl mb-6 text-center text-2xl font-semibold text-gray-900 leading-relaxed">
                Caricamento domanda...
            </div>

            <!-- Campo di input per la risposta dell'utente (per domande testuali) -->
            <input
                type="text"
                id="user-answer"
                placeholder="Scrivi qui la tua risposta..."
                class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg mb-4"
            >

            <!-- Contenitore per le opzioni a risposta multipla -->
            <div id="multiple-choice-options-container" class="multiple-choice-container hidden">
                <!-- Le opzioni saranno generate qui tramite JavaScript -->
            </div>

            <!-- Pulsanti per controllare e passare alla prossima domanda -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="check-button" class="button button-primary flex-1">Verifica</button>
                <button id="next-button" class="button button-secondary flex-1">Prossima Domanda</button>
            </div>

            <!-- Area per il feedback (corretto/sbagliato) -->
            <div id="feedback-message" class="feedback-message hidden">
                <!-- Il messaggio di feedback apparirà qui -->
            </div>

            <!-- Messaggio di punteggio finale -->
            <div id="final-score-message" class="hidden"></div>
        </div>
    </div>

    <script>
        // Array di oggetti contenente le domande e le risposte per un livello Cinese B2,
        // focalizzato su complementi di risultato, potenziale, direzionale e frasi con 把/被.
        // Include domande a risposta multipla. La correzione richiede precisione per caratteri/traduzioni.
        // Aumentato il numero di domande per un ciclo completo di 30+.
        const allQuestions = [
            // --- Complemento di Risultato ---
            {
                question: "Traduci: 'Ho letto il libro e l'ho finito.' (in caratteri cinesi)",
                answer: "我把书看完了。",
                hint: "Usa la struttura 把 e il complemento di risultato 完.",
                explanation: "Il complemento di risultato '完' (wán) indica il completamento di un'azione. La frase con '把' (bǎ) enfatizza l'oggetto su cui l'azione è stata completata.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '他听_____了老师的话。' (Ha ascoltato e capito le parole del professore.)",
                answer: "懂",
                hint: "Quale complemento di risultato indica la comprensione attraverso l'ascolto?",
                explanation: "Il complemento di risultato '懂' (dǒng) indica che un'azione ha portato alla comprensione. Qui, '听懂' significa 'capire ascoltando'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Ho scritto una lettera sbagliata.' (in caratteri cinesi)",
                answer: "我写错了信。",
                hint: "Usa il complemento di risultato 错.",
                explanation: "Il complemento di risultato '错' (cuò) indica che l'azione è stata eseguita in modo errato. '写错' significa 'scrivere sbagliato'.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '她把作业做_____了。' (Ha fatto i compiti e li ha finiti.)",
                answer: "完",
                hint: "Quale complemento di risultato indica il completamento?",
                explanation: "Il complemento di risultato '完' (wán) indica il completamento dell'azione di 'fare i compiti'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'La porta è stata aperta.' (in caratteri cinesi)",
                answer: "门被打开了。",
                hint: "Usa la struttura passiva con 被 e il complemento di risultato 开.",
                explanation: "La struttura passiva con '被' (bèi) indica che la porta ha subito l'azione. '打开' (dǎkāi) è un verbo con complemento di risultato che significa 'aprire'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Ho mangiato troppo e sono pieno.' (in caratteri cinesi)",
                answer: "我吃饱了。",
                hint: "Usa il complemento di risultato 饱 (bǎo).",
                explanation: "Il complemento di risultato '饱' (bǎo) indica lo stato di pienezza dopo aver mangiato.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '这本书我还没看_____。' (Questo libro non l'ho ancora finito di leggere.)",
                answer: "完",
                hint: "Quale complemento di risultato indica il completamento?",
                explanation: "Il complemento di risultato '完' (wán) con '还没' (hái méi) indica che l'azione non è stata ancora completata.",
                type: "text_input"
            },
            {
                question: "Quale frase usa correttamente il complemento di risultato '懂' (comprendere)?",
                options: ["他听不懂。", "他听得懂。", "他听懂。", "他听不。"],
                answer: "他听得懂。",
                explanation: "Il complemento potenziale 'V + 得/不 + Complemento' si usa per esprimere la possibilità o impossibilità di raggiungere un risultato. '听得懂' significa 'riesco a capire ascoltando'.",
                type: "multiple_choice"
            },
            {
                question: "In '他吃饱了' (Ha mangiato a sazietà), '饱' è un complemento di:",
                options: ["direzione", "quantità", "risultato", "tempo"],
                answer: "risultato",
                explanation: "'饱' (bǎo) indica il risultato dell'azione di mangiare, ovvero essere pieno.",
                type: "multiple_choice"
            },

            // --- Complemento Potenziale ---
            {
                question: "Traduci: 'Non posso finire questo compito.' (in caratteri cinesi)",
                answer: "我做不完这个作业。",
                hint: "Usa il complemento potenziale negativo.",
                explanation: "Il complemento potenziale '做不完' (zuòbùwán) indica l'impossibilità di completare l'azione (fare) a causa di una qualche difficoltà. La particella '不' (bù) si inserisce tra il verbo e il complemento di risultato/direzione.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '这本书太难了，我看不_____。' (Questo libro è troppo difficile, non riesco a capirlo.)",
                answer: "懂",
                hint: "Quale complemento potenziale negativo indica l'impossibilità di capire leggendo?",
                explanation: "Il complemento potenziale '看不懂' (kànbùdǒng) significa 'non riesco a capire leggendo'. Indica l'impossibilità di raggiungere il risultato (comprendere) attraverso l'azione (leggere).",
                type: "text_input"
            },
            {
                question: "Traduci: 'La stanza è così buia che non riesco a vedere nulla.' (in caratteri cinesi)",
                answer: "房间太黑了，我什么都看不见。",
                hint: "Usa il complemento potenziale negativo e '什么都...不/没...'.",
                explanation: "La frase '看不见' (kànbujiàn) significa 'non riesco a vedere'. Il complemento potenziale negativo '不' qui indica l'impossibilità di percepire il risultato (vedere). '什么都...' (shénme dōu...) è una costruzione enfatica di negazione totale.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '他跑得太快了，我追不_____。' (Lui corre troppo veloce, non riesco a raggiungerlo.)",
                answer: "上",
                hint: "Quale complemento potenziale negativo indica l'impossibilità di raggiungere qualcuno che è avanti?",
                explanation: "Il complemento potenziale '追不上' (zhuībùshàng) significa 'non riuscire a raggiungere'. Indica l'impossibilità di raggiungere il risultato (raggiungere) attraverso l'azione (inseguire).",
                type: "text_input"
            },
            {
                question: "Traduci: 'Questa domanda è così difficile che non riesco a risponderla.' (in caratteri cinesi)",
                answer: "这个问题太难了，我答不出来。",
                hint: "Usa il complemento potenziale negativo con un complemento di direzione.",
                explanation: "Il complemento potenziale '答不出来' (dábùchūlái) significa 'non riesco a rispondere/tirar fuori una risposta'. Indica l'impossibilità di produrre una risposta. '出来' (chūlái) in questo contesto è un complemento di direzione che denota l'emersione o la produzione.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '噪音太大，我听不_____你的话。' (Il rumore è troppo forte, non riesco a sentire le tue parole.)",
                answer: "清",
                hint: "Quale complemento potenziale indica l'impossibilità di sentire chiaramente?",
                explanation: "Il complemento potenziale '听不清' (tīngbùqīng) significa 'non riuscire a sentire chiaramente'. '清' (qīng) qui indica chiarezza o nitidezza.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Non riesco a trovare le mie chiavi.' (in caratteri cinesi)",
                answer: "我找不到我的钥匙。",
                hint: "Usa il complemento potenziale negativo con 找 (cercare).",
                explanation: "Il complemento potenziale '找不到' (zhǎobudào) significa 'non riuscire a trovare'.",
                type: "text_input"
            },
            {
                question: "Quale delle seguenti frasi esprime correttamente la capacità di leggere (capire)?",
                options: ["我看得懂这本书。", "我看不懂这本书。", "我看得不这本书。", "我看得这本书。"],
                answer: "我看得懂这本书。",
                explanation: "'V + 得 + C' (complemento potenziale positivo) indica la capacità di raggiungere il risultato. '看' (leggere) + '得' + '懂' (capire) = 'riesco a capire leggendo'.",
                type: "multiple_choice"
            },
            {
                question: "In '我今天走不动了' (Oggi non riesco più a camminare), '动' è un complemento di:",
                options: ["risultato", "direzione", "potenziale", "quantità"],
                answer: "potenziale",
                explanation: "'走不动' (zǒubùdòng) indica l'impossibilità fisica di continuare a camminare (动 - muoversi), ed è una forma di complemento potenziale.",
                type: "multiple_choice"
            },


            // --- Complemento Direzionale Semplice e Complesso ---
            {
                question: "Traduci: 'È salito al piano di sopra.' (in caratteri cinesi)",
                answer: "他上楼去了。",
                hint: "Usa il complemento direzionale '上...去'.",
                explanation: "Il complemento direzionale '上楼去' (shànglóu qù) indica il movimento verso l'alto (上) e l'allontanamento dall'osservatore (去).",
                type: "text_input"
            },
            {
                question: "Completa la frase: '老师走进_____了教室。' (Il professore è entrato in aula.)",
                answer: "去",
                hint: "Quale complemento direzionale semplice indica l'allontanamento dall'osservatore?",
                explanation: "Il complemento direzionale '进去' (jìnqù) indica il movimento verso l'interno (进) e l'allontanamento dall'osservatore (去).",
                type: "text_input"
            },
            {
                question: "Traduci: 'Ha tirato fuori il libro dalla borsa.' (in caratteri cinesi)",
                answer: "他把书从包里拿出来了。",
                hint: "Usa la struttura 把 e il complemento direzionale complesso '拿出来'.",
                explanation: "La struttura '把' (bǎ) sposta l'oggetto. '拿出来' (náchūlái) è un complemento di direzione complesso che indica l'azione di prendere qualcosa (拿) e portarlo fuori (出) verso l'osservatore (来).",
                type: "text_input"
            },
            {
                question: "Completa la frase: '请把那个箱子搬_____楼下。' (Per favor, porta quella scatola al piano di sotto.)",
                answer: "到",
                hint: "Quale verbo indica il raggiungimento di un luogo con un trasporto?",
                explanation: "Il verbo '搬' (bān, spostare) combinato con '到' (dào, arrivare a) forma '搬到' (bāndào) che significa 'spostare a/fino a'. Indica un'azione di movimento con un risultato di posizione.",
                type: "text_input"
            },
            {
                question: "Traduci: 'È volato via.' (in caratteri cinesi)",
                answer: "它飞走了。",
                hint: "Usa il complemento direzionale semplice '走'.",
                explanation: "Il complemento direzionale '走' (zǒu) qui non significa 'camminare', ma indica che qualcosa si è allontanato o ha lasciato un luogo (come 'via/andato').",
                type: "text_input"
            },
            {
                question: "Traduci: 'Ha portato il bambino a casa.' (in caratteri cinesi)",
                answer: "他把孩子带回家了。",
                hint: "Usa la struttura 把 e il complemento direzionale composto '带回家'.",
                explanation: "'带回家' (dàihuíjiā) è un complemento direzionale composto che indica l'azione di 'portare' (带) e 'tornare a casa' (回家).",
                type: "text_input"
            },
            {
                question: "Completa la frase: '他从楼上跑_____。' (È sceso correndo dal piano di sopra.)",
                answer: "下来",
                hint: "Quale complemento direzionale composto indica il movimento verso il basso e verso l'osservatore?",
                explanation: "'跑下来' (pǎoxiàlái) indica il movimento di 'correre' (跑) verso il basso (下) e in direzione dell'osservatore (来).",
                type: "text_input"
            },
            {
                question: "Quale delle seguenti frasi usa correttamente il complemento direzionale '进去'?",
                options: ["他走进房间来。", "他走进房间去。", "他走进房间出。", "他走进房间到。"],
                answer: "他走进房间去。",
                explanation: "'进去' (jìnqù) significa 'entrare (e allontanarsi dall'osservatore)'. '走进房间去' indica che il soggetto è entrato nella stanza allontanandosi da chi parla.",
                type: "multiple_choice"
            },
            {
                question: "In '他把行李拿上来了' (Lui ha portato su i bagagli), '上来' è un complemento di:",
                options: ["risultato", "potenziale", "direzione complessa", "quantità"],
                answer: "direzione complessa",
                explanation: "'上来' (shànglái) è un complemento di direzione complesso che indica un movimento verso l'alto (上) e verso l'osservatore (来).",
                type: "multiple_choice"
            },


            // --- Frasi con Particella 把 (bǎ) ---
            {
                question: "Traduci: 'Lui ha pulito la stanza.' (in caratteri cinesi)",
                answer: "他把房间打扫干净了。",
                hint: "Usa la struttura 把 e il complemento di risultato 干净.",
                explanation: "La struttura '把' (bǎ) enfatizza l'oggetto su cui viene eseguita un'azione che ne provoca un cambiamento. '打扫干净' (dǎsǎo gānjìng) significa 'pulire bene/rendere pulito'.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '请你把门_____上。' (Per favore, chiudi la porta.)",
                answer: "关",
                hint: "Quale verbo indica l'azione di chiudere?",
                explanation: "La struttura '把' (bǎ) + oggetto + verbo + complemento è comune. '关上' (guānshàng) significa 'chiudere'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Il bambino ha rotto il vaso.' (in caratteri cinesi)",
                answer: "孩子把花瓶打破了。",
                hint: "Usa la struttura 把 e il complemento di risultato 破.",
                explanation: "La struttura '把' (bǎ) indica che l'azione del soggetto ha causato un cambiamento nell'oggetto. '打破' (dǎpò) significa 'rompere'.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '我把钱还给_____了。' (Ho restituito i soldi a lui/lei.)",
                answer: "他/她",
                hint: "Usa il pronome corretto. Se ammessi sia maschile che femminile, puoi sceglierne uno.",
                explanation: "La struttura '把' (bǎ) + oggetto + verbo + '给' (gěi) + ricevente. '还给' (huán gěi) significa 'restituire a'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Lui ha venduto tutte le sue cose.' (in caratteri cinesi)",
                answer: "他把所有的东西都卖掉了。",
                hint: "Usa la struttura 把, '所有的' per 'tutte le', e il complemento di risultato 掉.",
                explanation: "La struttura '把' (bǎ) è usata per disporre di qualcosa. '所有的东西' (suǒyǒu de dōngxi) significa 'tutte le cose'. '卖掉' (màidiào) significa 'vendere via/sbarazzarsi vendendo'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Per favore, metti la tazza sul tavolo.' (in caratteri cinesi)",
                answer: "请把杯子放在桌子上。",
                hint: "Usa la struttura 把 e il complemento di luogo '放在'.",
                explanation: "La struttura '把' (bǎ) introduce l'oggetto prima del verbo per indicare la sua manipolazione o disposizione. '放在' (fàngzài) significa 'mettere su/in'.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '他把那本书送_____朋友了。' (Lui ha regalato quel libro all'amico.)",
                answer: "给",
                hint: "Quale preposizione si usa per indicare il beneficiario dell'azione?",
                explanation: "Nella struttura '把' (bǎ) + oggetto + verbo + '给' (gěi) + ricevente, '给' introduce il beneficiario dell'azione.",
                type: "text_input"
            },
            {
                question: "Quale frase con '把' è grammaticalmente corretta?",
                options: ["他把饭吃了。", "他吃了把饭。", "把饭他吃了。", "饭他吃了把。"],
                answer: "他把饭吃了。",
                explanation: "Nella frase con '把' (bǎ), l'oggetto (饭) si posiziona dopo '把' e prima del verbo (吃). La particella '了' indica il completamento dell'azione.",
                type: "multiple_choice"
            },
            {
                question: "Quale parola manca in '我把作业____完了' (Ho finito i compiti)?",
                options: ["做", "写", "看", "说"],
                answer: "做",
                explanation: "Il verbo '做' (zuò, fare) è il verbo più comune per 'fare i compiti' (做作业). '做完' significa 'finire di fare'.",
                type: "multiple_choice"
            },

            // --- Frasi Passive con 被 (bèi) ---
            {
                question: "Traduci: 'Il ladro è stato catturato dalla polizia.' (in caratteri cinesi)",
                answer: "小偷被警察抓住了。",
                hint: "Usa la struttura passiva con 被.",
                explanation: "La struttura passiva con '被' (bèi) + agente (警察) + verbo + complemento ('抓住' - catturare). Indica che il soggetto (小偷) ha subito l'azione.",
                type: "text_input"
            },
            {
                question: "Completa la frase: '他的手机被_____了。' (Il suo cellulare è stato rubato.)",
                answer: "偷",
                hint: "Quale verbo indica l'azione di rubare?",
                explanation: "La struttura passiva con '被' (bèi). '偷' (tōu) significa 'rubare'. Implica che il telefono è stato il bersaglio dell'azione.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Questo problema è stato risolto.' (in caratteri cinesi)",
                answer: "这个问题被解决了。",
                hint: "Usa la struttura passiva con 被 e il verbo 'risolvere'.",
                explanation: "La struttura '被' (bèi) indica che il problema (soggetto) è stato il ricevente dell'azione di 'risolvere' (解决 jiějué).",
                type: "text_input"
            },
            {
                question: "Completa la frase: '我被他的话_____了。' (Sono rimasto/a commosso/a dalle sue parole.)",
                answer: "感动",
                hint: "Quale verbo significa 'commuovere'?",
                explanation: "La struttura '被' (bèi) è usata quando il soggetto subisce un'azione che lo influenza emotivamente. '感动' (gǎndòng) significa 'commuovere/toccare emotivamente'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'La finestra è stata rotta dal vento.' (in caratteri cinesi)",
                answer: "窗户被风刮破了。",
                hint: "Usa la struttura passiva con 被 e il verbo 'soffiare/spazzare via' con complemento di risultato 'rotto'.",
                explanation: "La struttura '被' (bèi) con l'agente '风' (fēng, vento). '刮破' (guāpò) significa 'rompere soffiando via'.",
                type: "text_input"
            },
            {
                question: "Traduci: 'Il mio passaporto è stato rubato.' (in caratteri cinesi)",
                answer: "我的护照被偷了。",
                hint: "Usa la struttura passiva con 被 e il verbo 'rubare'.",
                explanation: "La struttura passiva con '被' (bèi) indica che il passaporto ha subito l'azione di essere rubato ('偷' tōu).",
                type: "text_input"
            },
            {
                question: "Completa la frase: '他的计划被_____了。' (Il suo piano è stato annullato.)",
                answer: "取消",
                hint: "Quale verbo significa 'annullare' o 'cancellare'?",
                explanation: "La struttura passiva con '被' (bèi). '取消' (qǔxiāo) significa 'annullare/cancellare'.",
                type: "text_input"
            },
            {
                question: "Quale delle seguenti frasi è una costruzione passiva corretta con '被'?",
                options: ["他被这本书读了。", "这本书被他读完了。", "这本书被读了他。", "他读了这本书被。"],
                answer: "这本书被他读完了。",
                explanation: "Nella costruzione passiva con '被' (bèi), l'agente (他) viene posto dopo '被', e il verbo '读完' (leggere e finire) segue. Il soggetto logico diventa il soggetto grammaticale.",
                type: "multiple_choice"
            },
            {
                question: "Quale particella passiva può sostituire '被' in alcune frasi?",
                options: ["把", "给", "让", "到"],
                answer: "让",
                explanation: "Oltre a '被' (bèi), anche '让' (ràng) e '叫' (jiào) possono essere usati per formare frasi passive, specialmente in contesti più colloquiali.",
                type: "multiple_choice"
            }
        ];

        let correctAnswersCount = 0; // Contatore risposte corrette
        let totalQuestionsAnswered = 0; // Contatore domande risposte
        const questionsPerCycle = 30; // Numero di domande per ciclo
        let shuffledQuestions = []; // Array per le domande mescolate (per il ciclo corrente)
        let currentQuestionIndex = 0; // Indice della domanda corrente all'interno del ciclo

        // Elementi del DOM
        const landingPage = document.getElementById('landing-page');
        const exerciseAppContainer = document.getElementById('exercise-app-container');
        const mobileModeButton = document.getElementById('mobile-mode-button');
        const desktopModeButton = document.getElementById('desktop-mode-button');
        const mainCardContainer = document.getElementById('main-card-container'); // Otteniamo l'ID del card-container

        const questionArea = document.getElementById('question-area');
        const userAnswerInput = document.getElementById('user-answer');
        const multipleChoiceOptionsContainer = document.getElementById('multiple-choice-options-container');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreMessage = document.getElementById('final-score-message');

        /**
         * Funzione per mescolare l'array delle domande (algoritmo Fisher-Yates).
         * Questo assicura che le domande appaiano in un ordine casuale ad ogni sessione.
         */
        function shuffleArray(array) {
            const shuffled = [...array]; // Crea una copia per non modificare l'originale
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; // Scambia elementi
            }
            return shuffled;
        }

        /**
         * Aggiorna la visualizzazione del punteggio in tempo reale.
         */
        function updateScoreDisplay() {
            scoreDisplay.textContent = `Punteggio: ${correctAnswersCount}/${totalQuestionsAnswered}`;
        }

        /**
         * Visualizza la domanda corrente e gestisce l'interfaccia utente.
         */
        function renderCurrentQuestion() {
            if (currentQuestionIndex >= questionsPerCycle) {
                // Se tutte le 30 domande del ciclo sono state mostrate
                showFinalScore();
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];

            // Nasconde/mostra il campo di input testuale o le opzioni a risposta multipla
            if (currentQuestion.type === "multiple_choice") {
                userAnswerInput.classList.add('hidden');
                multipleChoiceOptionsContainer.classList.remove('hidden');
                renderMultipleChoiceOptions(currentQuestion.options);
            } else {
                userAnswerInput.classList.remove('hidden');
                multipleChoiceOptionsContainer.classList.add('hidden');
            }

            questionArea.textContent = currentQuestion.question;
            userAnswerInput.value = ''; // Pulisce il campo di input
            userAnswerInput.disabled = false; // Riabilita l'input
            checkButton.disabled = false; // Riabilita il pulsante di verifica

            // Nasconde il feedback precedente
            feedbackMessage.classList.add('hidden');
            feedbackMessage.classList.remove('feedback-correct', 'feedback-incorrect');
            feedbackMessage.innerHTML = '';
            
            // Per le domande a risposta multipla, deseleziona eventuali opzioni selezionate
            const selectedRadio = document.querySelector('input[name="mc-option"]:checked');
            if (selectedRadio) {
                selectedRadio.checked = false;
            }

            // Imposta il focus correttamente a seconda del tipo di domanda
            if (currentQuestion.type === "text_input") {
                userAnswerInput.focus();
            }
            updateScoreDisplay(); // Aggiorna il punteggio visualizzato
        }

        /**
         * Mostra il punteggio finale e prepara l'interfaccia per il riavvio.
         */
        function showFinalScore() {
            finalScoreMessage.textContent = `Risultato finale: ${correctAnswersCount}/${questionsPerCycle}. Ottimo lavoro!`;
            finalScoreMessage.classList.remove('hidden');
            questionArea.textContent = "Ciclo di esercizi completato!";
            userAnswerInput.value = '';
            userAnswerInput.disabled = true; // Disabilita l'input
            checkButton.disabled = true; // Disabilita il pulsante di verifica
            nextButton.textContent = 'Ricomincia'; // Cambia il testo del pulsante in "Ricomincia"
            nextButton.onclick = restartExercise; // Imposta il listener per il riavvio
            feedbackMessage.classList.add('hidden');
            feedbackMessage.innerHTML = '';
            scoreDisplay.textContent = `Punteggio finale: ${correctAnswersCount}/${questionsPerCycle}`; // Aggiorna display finale
        }

        /**
         * Genera dinamicamente le opzioni a risposta multipla.
         */
        function renderMultipleChoiceOptions(options) {
            multipleChoiceOptionsContainer.innerHTML = ''; // Pulisce le opzioni precedenti
            // Mescola le opzioni per ogni domanda a risposta multipla
            const shuffledOptions = shuffleArray(options); 

            shuffledOptions.forEach((option, index) => {
                const label = document.createElement('label');
                label.classList.add('multiple-choice-option');
                label.innerHTML = `
                    <input type="radio" name="mc-option" value="${option.toLowerCase()}" id="option-${index}">
                    <span>${option}</span>
                `;
                multipleChoiceOptionsContainer.appendChild(label);
            });
        }

        /**
         * Riavvia l'intero ciclo di esercizi.
         */
        function restartExercise() {
            correctAnswersCount = 0;
            totalQuestionsAnswered = 0;
            currentQuestionIndex = 0;
            shuffledQuestions = shuffleArray(allQuestions).slice(0, questionsPerCycle); // Mescola e seleziona le prime 30
            renderCurrentQuestion(); // Carica la prima domanda del nuovo ciclo
            nextButton.textContent = 'Prossima Domanda'; // Ripristina il testo del pulsante
            nextButton.onclick = moveToNextQuestion; // Ripristina il comportamento normale del pulsante
            finalScoreMessage.classList.add('hidden'); // Nasconde il messaggio finale
        }

        /**
         * Avanza alla prossima domanda nel ciclo.
         */
        function moveToNextQuestion() {
            currentQuestionIndex++; // Incrementa l'indice per la prossima domanda
            renderCurrentQuestion(); // Visualizza la prossima domanda
        }


        /**
         * Controlla la risposta dell'utente.
         * Confronta la risposta fornita con quella corretta e mostra feedback e spiegazione.
         */
        function checkAnswer() {
            // Se siamo già alla fine del ciclo o l'input è disabilitato, non fare nulla
            if (totalQuestionsAnswered >= questionsPerCycle || userAnswerInput.disabled) {
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            let userAnswerNormalized = '';
            let isCorrect = false;

            if (currentQuestion.type === "multiple_choice") {
                const selectedOption = document.querySelector('input[name="mc-option"]:checked');
                if (selectedOption) {
                    userAnswerNormalized = selectedOption.value;
                } else {
                    feedbackMessage.textContent = 'Per favore, seleziona un\'opzione.';
                    feedbackMessage.classList.remove('hidden', 'feedback-correct');
                    feedbackMessage.classList.add('feedback-incorrect');
                    return; // Non incrementare il conteggio delle domande se non è stata selezionata un'opzione
                }
            } else { // type === "text_input"
                userAnswerNormalized = userAnswerInput.value.trim().toLowerCase();
            }

            const correctAnswerNormalized = currentQuestion.answer.toLowerCase();

            feedbackMessage.classList.remove('hidden');

            // La correzione si basa su una corrispondenza esatta per entrambi i tipi
            if (userAnswerNormalized === correctAnswerNormalized) {
                feedbackMessage.textContent = 'Corretto! Ottimo lavoro!';
                feedbackMessage.classList.add('feedback-correct');
                feedbackMessage.classList.remove('feedback-incorrect');
                correctAnswersCount++; // Incrementa solo se la risposta è corretta
            } else {
                let feedbackText = `Sbagliato. La risposta corretta era: "${currentQuestion.answer}"`;
                if (currentQuestion.explanation) {
                    feedbackText += `<div class="explanation">Spiegazione: ${currentQuestion.explanation}</div>`;
                }
                feedbackMessage.innerHTML = feedbackText;
                feedbackMessage.classList.add('feedback-incorrect');
                feedbackMessage.classList.remove('feedback-correct');
            }
            
            totalQuestionsAnswered++; // Incrementa il contatore delle domande risposte
            updateScoreDisplay(); // Aggiorna il punteggio dopo ogni tentativo
        }

        // --- Gestione della selezione della modalità ---
        function selectMode(mode) {
            landingPage.style.display = 'none'; // Nasconde la landing page
            exerciseAppContainer.style.display = 'flex'; // Mostra il contenitore degli esercizi
            
            // Rimuovi tutte le classi di layout esistenti dal body
            document.body.classList.remove('mobile-layout', 'desktop-layout');
            // Aggiungi la classe di layout della modalità selezionata
            document.body.classList.add(`${mode}-layout`);

            restartExercise(); // Avvia l'esercitazione una volta selezionata la modalità
        }

        // Aggiunta degli event listener ai pulsanti di selezione modalità
        mobileModeButton.addEventListener('click', () => selectMode('mobile'));
        desktopModeButton.addEventListener('click', () => selectMode('desktop'));

        // Aggiunta degli event listener ai pulsanti dell'esercitazione
        checkButton.addEventListener('click', checkAnswer);
        nextButton.addEventListener('click', moveToNextQuestion);

        // Aggiungi un event listener per il tasto "Invio" nel campo di input testuale
        userAnswerInput.addEventListener('keypress', function(event) {
            // Assicurati che sia il campo di testo visibile
            if (!userAnswerInput.classList.contains('hidden') && event.key === 'Enter') {
                event.preventDefault();
                checkAnswer();
            }
        });

        // Inizializza l'applicazione quando la pagina è completamente caricata
        window.onload = function() {
            // All'inizio, mostra solo la landing page. L'esercitazione verrà caricata dopo la selezione della modalità.
            landingPage.style.display = 'flex';
            exerciseAppContainer.style.display = 'none';
        };

    </script>
</body>
</html>
